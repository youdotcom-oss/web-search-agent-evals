name: Playoffs Evaluation

on:
  # Manual trigger for full workflow
  workflow_dispatch:
    inputs:
      prompt_set:
        description: 'Prompt set to use'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - full
      parallel:
        description: 'Run agents in parallel (faster but may hit rate limits)'
        required: true
        default: false
        type: boolean

  # Automated tests on changes
  push:
    branches: [main, 'feat/**', 'fix/**']
    paths:
      - 'agent-schemas/**'
      - 'data/prompts/**'
      - 'docker/**'
      - 'scripts/**'
      - 'tools/**'
      - 'docker-compose.yml'

  pull_request:
    paths:
      - 'agent-schemas/**'
      - 'data/prompts/**'
      - 'docker/**'
      - 'scripts/**'
      - 'tools/**'
      - 'docker-compose.yml'

jobs:
  # Path filtering to determine what changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      schemas: ${{ steps.filter.outputs.schemas }}
      prompts: ${{ steps.filter.outputs.prompts }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            schemas:
              - 'agent-schemas/**'
              - 'docker/**'
            prompts:
              - 'data/prompts/**'

  # Test run with 5 prompts (fast validation)
  test:
    needs: changes
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.prompt_set == 'test') ||
      (github.event_name == 'push' && (needs.changes.outputs.schemas == 'true' || needs.changes.outputs.prompts == 'true'))
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      # Run all 8 combinations in parallel for test prompts (fast enough)
      matrix:
        agent: [claude-code, gemini, droid, codex]
        tool: [builtin, you]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build Docker image
        run: |
          docker compose build ${{ matrix.agent }}-${{ matrix.tool }}

      - name: Run evaluation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          YOU_API_KEY: ${{ secrets.YOU_API_KEY }}
        run: |
          docker compose run --rm ${{ matrix.agent }}-${{ matrix.tool }}

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.agent }}-${{ matrix.tool }}
          path: data/results/${{ matrix.agent }}/${{ matrix.tool }}.jsonl
          retention-days: 30

  # Full run with 1,254 prompts (only on main or manual trigger)
  # Sequential: ~24 hours (safe for rate limits)
  # Parallel: ~4 hours (may hit rate limits)
  full:
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.prompt_set == 'full') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max per agent (Codex can be slow)
    strategy:
      fail-fast: false
      # Parallel mode: faster but may hit API rate limits
      # Sequential mode: safer for rate limits, takes longer
      max-parallel: ${{ github.event.inputs.parallel == 'true' && 8 || 1 }}
      matrix:
        agent: [claude-code, gemini, droid, codex]
        tool: [builtin, you]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Update docker-compose for full prompts
        run: |
          sed -i 's|/eval/data/prompts/test.jsonl|/eval/data/prompts/full.jsonl|g' docker-compose.yml
          sed -i 's|/eval/data/prompts/test-mcp.jsonl|/eval/data/prompts/full-mcp.jsonl|g' docker-compose.yml

      - name: Build Docker image
        run: |
          docker compose build ${{ matrix.agent }}-${{ matrix.tool }}

      - name: Run evaluation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          YOU_API_KEY: ${{ secrets.YOU_API_KEY }}
        run: |
          docker compose run --rm ${{ matrix.agent }}-${{ matrix.tool }}

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: full-results-${{ matrix.agent }}-${{ matrix.tool }}
          path: data/results/${{ matrix.agent }}/${{ matrix.tool }}.jsonl
          retention-days: 90

  # Commit results back to repo (only for full runs)
  commit-results:
    needs: full
    if: success()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: full-results-*
          path: data/results/
          merge-multiple: true

      - name: Create results branch
        run: |
          BRANCH_NAME="results/full-workflow-$(date +%Y%m%d-%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git add data/results/
          git commit -m "results: full workflow evaluation from CI

          Completed full evaluation of 4 agents × 2 tools × 1,254 prompts.

          - Trigger: ${{ github.event_name }}
          - Agents: Claude Code, Gemini, Droid, Codex
          - Tools: builtin, You.com MCP
          - Prompts: 1,254 web search queries

          Results ready for downstream data science analysis."
          git push -u origin "$BRANCH_NAME"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.commit-results.outputs.branch_name }}
          title: "Results: Full workflow evaluation"
          body: |
            ## Full Workflow Results

            This PR contains results from a full playoff evaluation run.

            **Configuration:**
            - **Agents:** Claude Code, Gemini, Droid, Codex
            - **Tools:** builtin, You.com MCP
            - **Prompts:** 1,254 web search queries
            - **Trigger:** ${{ github.event_name }}

            **Results:**
            - `data/results/*/builtin.jsonl` - Native search results
            - `data/results/*/you.jsonl` - MCP (You.com) results

            Ready for downstream data science analysis.
